import os
import subprocess
import sys
from tqdm import tqdm
import shutil

def validate_dicom_folder(folder_path: str) -> bool:
    for f in os.listdir(folder_path):
        if f.lower().endswith('.dcm') or (not '.' in f):
            return True
    return False

def run_pancreas_segmentation(dicom_folder: str, output_path: str):
    try:
        if not validate_dicom_folder(dicom_folder):
            print(f"DICOM íŒŒì¼ì´ ì—†ëŠ” ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤: {dicom_folder}")
            return False

        segmentator_cmd = "TotalSegmentator"

        command = [
            segmentator_cmd,
            "-i", dicom_folder,
            "-o", output_path,
            "--fast",
            "--ml",
            "--roi_subset", "pancreas",
            "--ignore_errors",
            "--output_type", "nifti"
        ]

        print(f"\nëª…ë ¹ì–´ ì‹¤í–‰: {' '.join(command)}")

        result = subprocess.run(command, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
        print(f"ì²˜ë¦¬ ì™„ë£Œ: {dicom_folder}")
        return True

    except subprocess.CalledProcessError as e:
        print(f"ì²˜ë¦¬ ì‹¤íŒ¨: {dicom_folder}")
        print("ì‹¤íŒ¨í•œ ëª…ë ¹ì–´:", ' '.join(e.cmd))
        print("STDOUT:\n", e.stdout)
        print("STDERR:\n", e.stderr)
        return False

    except Exception as e:
        print(f"ì˜ˆì™¸ ë°œìƒ: {dicom_folder}")
        print(str(e))
        return False

def move_output(base_path: str, patient_id: str, phase: str) -> bool:
    """pancreas.nii.gzë¥¼ ìƒˆ í´ë”(PRE_patient_001 ë“±)ë¡œ ì´ë™ ë° ì´ë¦„ ë³€ê²½"""
    original_folder = os.path.join(base_path, patient_id, phase)
    original_file = os.path.join(original_folder, "pancreas.nii.gz")

    if os.path.exists(original_file):
        target_folder_name = f"{phase}_patient_{patient_id}"
        target_folder = os.path.join(base_path, target_folder_name)
        os.makedirs(target_folder, exist_ok=True)

        target_file = os.path.join(target_folder, f"{phase}_pancreas.nii.gz")
        shutil.move(original_file, target_file)

        print(f"â†’ ì €ì¥ ì™„ë£Œ: {target_file}")
        return True
    else:
        print(f"âš ï¸ ê²°ê³¼ íŒŒì¼ ì—†ìŒ: {original_file}")
        return False

def main():
    print("ì˜ˆì‹œ: /mnt/shared/CT_DICOM ë˜ëŠ” C:\\Users\\User\\Desktop\\DICOM")
    base_path = input("ìƒìœ„ í™˜ì í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”: ").strip()
    base_path = os.path.normpath(base_path)

    if not os.path.exists(base_path):
        print(f"í•´ë‹¹ ê²½ë¡œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {base_path}")
        sys.exit(1)

    failed_cases = []

    patient_folders = [d for d in os.listdir(base_path)
                       if os.path.isdir(os.path.join(base_path, d)) and d.isdigit()]

    for patient_id in tqdm(patient_folders, desc="ì „ì²´ í™˜ì ì§„í–‰ë¥ "):
        patient_folder = os.path.join(base_path, patient_id)

        for phase in ['PRE', 'POST']:
            phase_folder = os.path.join(patient_folder, phase)

            if os.path.isdir(phase_folder):
                print(f"\nì²˜ë¦¬ ì¤‘: {phase_folder}")
                if run_pancreas_segmentation(phase_folder, phase_folder):
                    if not move_output(base_path, patient_id, phase):
                        failed_cases.append(f"{patient_id}/{phase} (ê²°ê³¼ íŒŒì¼ ì—†ìŒ)")
                else:
                    failed_cases.append(f"{patient_id}/{phase} (segmentation ì‹¤íŒ¨)")

    if failed_cases:
        print("\nğŸ”» ì‹¤íŒ¨í•œ ì¼€ì´ìŠ¤ ëª©ë¡:")
        for item in failed_cases:
            print(" -", item)
    else:
        print("\nâœ… ëª¨ë“  ì¼€ì´ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main()
